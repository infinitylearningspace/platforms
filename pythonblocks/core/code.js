"use strict";var Code={},libToInstall="";function loadExampleFromURL(e){var o=new XMLHttpRequest;o.open("GET","/beta2/ui/examples/"+e+".xml",!0),o.send(null),o.onreadystatechange=function(){if(4===o.readyState&&200===o.status&&1!==o.getResponseHeader("Content-Type").indexOf("text")){var e=o.responseText,t=Blockly.Xml.textToDom(e);return Blockly.Xml.domToWorkspace(t,Code.workspace),o.responseText}}}function loadDoc(){var e="";"pt-br"==Code.getLang()&&(e="https://docs.google.com/document/d/e/2PACX-1vT7dc6hP4sKyMJupklbGK4adIf3qCkt4r-HrEWO8jTRMx9uUOUSfboKG749IF3DZr8k6zUPSLXkrDGY/pub"),"en"==Code.getLang()&&(e="https://docs.google.com/document/d/e/2PACX-1vSk-9T56hP9K9EOhkF5SoNzsYl4TzDk-GEDnMssaFP_m-LEfI6IU-uRkkLP_HoONK0QmMrZVo_f27Fw/pub"),window.open(e,"_blank").focus()}Code.LANGUAGE_NAME={en:"English","pt-br":"Portugues",es:"Espanol",it:"Italiano",fr:"French",de:"Deutsch",nb:"Norwegian","zh-hans":"Chinese (simplified)","zh-hant":"Chinese (tradicional)",he:"Hebrew"},Code.LANGUAGE_RTL=["ar","fa","he","lki"],Code.workspace=null,Code.getStringParamFromUrl=function(e,o){var t=location.search.match(RegExp("[?&]"+e+"=([^&]+)"));return t?decodeURIComponent(t[1].replace(/\+/g,"%20")):o},Code.getLang=function(){var e=Code.getStringParamFromUrl("lang","");return void 0===Code.LANGUAGE_NAME[e]&&(e="en"),e},Code.isRtl=function(){return -1!=Code.LANGUAGE_RTL.indexOf(Code.LANG)},Code.loadBlocks=function(e){try{var o=window.sessionStorage.loadOnceBlocks}catch(t){var o=null}var n=setInterval(()=>{if("undefined"!=typeof UI&&"Object"==UI.workspace.devices.constructor.name){if("BlocklyStorage"in window&&window.location.hash.length>1)BlocklyStorage.restoreBlocks(),BlocklyStorage.retrieveXml(window.location.hash.substring(1));else if(o){delete window.sessionStorage.loadOnceBlocks;var t=Blockly.Xml.textToDom(o);Blockly.Xml.domToWorkspace(t,Code.workspace)}else if(e){var t=Blockly.Xml.textToDom(e);Blockly.Xml.domToWorkspace(t,Code.workspace)}else"BlocklyStorage"in window&&("undefined"!=typeof UI&&UI.workspace.devices.constructor.name,window.setTimeout(()=>{BlocklyStorage.restoreBlocks(),UI.account.openLastEdited()},0));clearInterval(n)}},500)},Code.changeLanguage=function(){if(window.sessionStorage){var e=Blockly.Xml.workspaceToDom(Code.workspace),o=Blockly.Xml.domToText(e);window.sessionStorage.loadOnceBlocks=o}var t=document.getElementById("languageMenu"),n=encodeURIComponent(t.options[t.selectedIndex].value),r=window.location.search;r=r.length<=1?"?lang="+n:r.match(/[?&]lang=[^&]*/)?r.replace(/([?&]lang=)[^&]*/,"$1"+n):r.replace(/\?/,"?lang="+n+"&"),window.location=window.location.protocol+"//"+window.location.host+window.location.pathname+r},Code.bindClick=function(e,o){"string"==typeof e&&(e=document.getElementById(e)),e.addEventListener("click",o,!0)},Code.importPrettify=function(){var e=document.createElement("script");e.setAttribute("src","https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"),document.head.appendChild(e)},Code.LANG=Code.getLang(),Code.TABS_=["blocks","console","files","device","programs","databoard","mqtt","iot"],Code.current=["blocks","",""],Code.handleLink=(e,o)=>{let t=2==o?1:2,n=Code.current,r=(e,o)=>{let t=get(`#content_${e}`),n=get(`#tab_${e}`);Code.deinitContent(e),n.classList.remove("on"),1==o&&t.classList.add("_pos1"),2==o&&t.classList.add("_pos2"),t.classList.remove(`pos${o}`),Animate.off(t)},a=(e,o)=>{let t=get(`#content_${e}`),n=get(`#tab_${e}`);Code.renderContent(e),n.classList.add("on"),Animate.on(t),t.classList.remove("_pos1","_pos2"),0!=o&&t.classList.add(`pos${o}`)};if(0==o){a(e,0),Code.current=[e,"",""];return}if(n[t]==e){let s=get(`#content_${n[o]}`),l=get(`#content_${n[t]}`);s.classList.remove(`pos${o}`),s.classList.add(`pos${t}`),l.classList.remove(`pos${t}`),l.classList.add(`pos${o}`),Code.current=["",n[2],n[1]];return}if(n[0]!=e||""!=n[1]||""!=n[2]){if(1==o&&""!=n[0]){r(n[0],0),n[0]=e,a(n[0],0),Code.resizeContent();return}if(1==o&&n[o]==e&&""!=n[t]){r(n[t],t);get(`#content_${n[o]}`).classList.remove(`pos${o}`),Code.current=[e,"",""],Code.resizeContent();return}if(2==o&&n[o]==e&&""!=n[t]){r(n[o],o);get(`#content_${n[t]}`).classList.remove(`pos${t}`),Code.current=[n[t],"",""],Code.resizeContent();return}if(n[o]!=e&&""==n[0]){""!=n[o]&&r(n[o],o),a(e,o),Code.current[o]=e,Code.resizeContent();return}if(2==o&&n[o]!=e&&""!=n[0]){get(`#content_${n[0]}`).classList.add("pos1"),a(e,2),Code.current=["",n[0],e],Code.resizeContent();return}}},Code.renderContent=e=>{if(void 0===e)return;let o=get(`#content_${e}`);switch(e){case"databoard":setTimeout(()=>{if(window.frames[3].inited)window.frames[3].initGrid();else if("object"==typeof window.frames[3].modules&&"object"==typeof window.frames[3].modules.Workspaces)window.frames[3].initDataStorage();else var e=setInterval(()=>{"object"==typeof window.frames[3].modules&&"object"==typeof window.frames[3].modules.Workspaces&&(window.frames[3].initDataStorage(),window.frames[3].inited&&clearInterval(e))},500)},10);break;case"blocks":Code.workspace.setVisible(!0),Code.auto_mode=!0,Blockly.svgResize(Code.workspace);break;case"files":void 0==Files.editor.init&&(Files.editor.setValue(Array(9).fill("\r\n").join("")),setTimeout(()=>{Files.editor.setValue(""),Files.editor.init=!0},10)),Files.handleCurrentProject();break;case"console":term.resize()}o.focus()},Code.resizeContent=e=>{Code.current.forEach(e=>{switch(e){case"blocks":setTimeout(()=>{Blockly.svgResize(Code.workspace)},250);break;case"files":Files.resize();break;case"console":term.resize()}})},Code.deinitContent=e=>{switch(e){case"databoard":window.frames[3].grid_inited&&window.frames[3].deinitGrid();break;case"blocks":Code.workspace.setVisible(!1),Code.auto_mode=!1}},Code.toDOM=function(e,o,t){var n=document.getElementById(t);n.textContent="",n.textContent=e,"function"==typeof PR.prettyPrintOne&&(e=n.textContent,e=PR.prettyPrintOne(e,o),n.innerHTML=e)},Code.checkAllGeneratorFunctionsDefined=function(e){for(var o=Code.workspace.getAllBlocks(),t=[],n=0;n<o.length;n++){var r=o[n].type;e[r]||-1!==t.indexOf(r)||t.push(r)}var a=0==t.length;if(!a){var s="The generator code for the following blocks not specified for "+e.name_+":\n - "+t.join("\n - ");Blockly.alert(s)}return a},Code.reloadToolbox=function(e){let o=new XMLSerializer().serializeToString(e).replace(/(^|[^%]){(\w+)}/g,function(e,o,t){return o+MSG[t]}),t=Blockly.Xml.textToDom(o);Code.workspace.updateToolbox(t),Code.workspace.scrollCenter()},Code.auto_mode=!1,Code.generateCode=function(e=Blockly.Python){if(Code.auto_mode||"Window"!=this.constructor.name){if(Code.checkAllGeneratorFunctionsDefined(e)){if("Python"==e.name_||"Javascript"==e.name_)return e.workspaceToCode(Code.workspace)}else Code.auto_mode=!1}},Code.generateXML=function(e=Code.workspace){let o=Blockly.Xml.workspaceToDom(e),t=Blockly.Xml.domToPrettyText(o);return UI.workspace.writeWorkspace(t,!0)},Code.init=function(){Code.initLanguage();var e=Code.isRtl();for(var o in setInterval(Code.generateCode,250),Code.auto_mode=!0,MSG)0==o.indexOf("cat")&&(Blockly.Msg[o.toUpperCase()]=MSG[o]);let t=Blockly.Xml.textToDom("<xml><category name='...'></category></xml>");Code.workspace=Blockly.inject("content_blocks",{grid:{spacing:25,length:3,colour:"#ccc",snap:!0},media:"media/",rtl:e,toolbox:t,oneBasedIndex:!1,zoom:{controls:!0,wheel:!0}}),Code.loadBlocks(""),"BlocklyStorage"in window&&BlocklyStorage.backupOnUnload(Code.workspace),Code.handleLink(Code.current[0],0),Code.bindClick("forumButton",function(){window.open("https://github.com/BIPES/BIPES/discussions","_blank")});var n=document.getElementById("linkButton");"BlocklyStorage"in window?(BlocklyStorage.HTTPREQUEST_ERROR=MSG.httpRequestError,BlocklyStorage.LINK_ALERT=MSG.linkAlert,BlocklyStorage.HASH_ERROR=MSG.hashError,BlocklyStorage.XML_ERROR=MSG.xmlError,Code.bindClick(n,function(){BlocklyStorage.link(Code.workspace)})):n&&(n.className="disabled");for(var r=0;r<Code.TABS_.length;r++){let a=Code.TABS_[r],s=get(`#tab_${a}`);s.addEventListener("click",e=>{e.preventDefault(),Code.handleLink(a,1)}),s.addEventListener("contextmenu",e=>{e.preventDefault(),Code.handleLink(a,2)})}Blockly.svgResize(Code.workspace),Code.workspace.registerButtonCallback("installPyLib",function(e){var o=e.text_.split(" ")[1];console.log(e.text_),console.log(o),alert("This will automatic download and install the library on the connected board: "+o+". Internet is required for this operation. Install results will be shown on console tab.");var t=`
def bipesInstall(url, lib):
    import socket
    _, _, host, path = url.split('/', 3)
    addr = socket.getaddrinfo(host, 80)[0][-1]
    s = socket.socket()
    s.connect(addr)
    print('Downloading from ' + url)
    s.send(bytes('GET /%s HTTP/1.0\\r\\nHost: %s\\r\\n\\r\\n' % (path, host), 'utf8'))

    f = open('tmplib.py', 'w')
    #f = open(lib, 'w')

    while True:
        data = s.recv(100)
        if data:
            #print(str(data, 'utf8'), end='')
            f.write(data)
            #print('.')
        else:
            break
    s.close()
    f.close()
    print('Download done')

`;t=t+"lib = '"+o+".py'\r",t+="bipesInstall('http://bipes.net.br/beta2/ui/pylibs/' + lib, lib)",Tool.runPython(t);var n=`
f=open("tmplib.py", "r")
c=open("`;n+=o+`.py", "w")
lineC=0
for line in f:
	lineC=lineC+1
	#Jump 10 lines to skip HTTP header
	if lineC >= 10:
		r=c.write(line)
		print('.', end='')
f.close()
c.close()
print('Install done.')

`,Tool.runPython(n)}),Code.workspace.registerButtonCallback("loadExample",function(e){var o=e.text_.split(":")[1].replace(/\s/g,"");confirm("This will load Example: "+o+". Internet is required for this operation. Important: all blocks on workspace will be lost and replaced by the example blocks. Do you want to continue?")?(Code.workspace.clear(),Code.renderContent(),loadExampleFromURL(o),Code.renderContent()):console.log("Example load canceled.")}),Code.workspace.registerButtonCallback("loadDoc",function(e){var o=e.text_.split(":")[1].replace(/\s/g,""),t="https://docs.google.com/document/d/e/2PACX-1vSk-9T56hP9K9EOhkF5SoNzsYl4TzDk-GEDnMssaFP_m-LEfI6IU-uRkkLP_HoONK0QmMrZVo_f27Fw/pub";"pt-br"==Code.getLang()&&(t="https://docs.google.com/document/d/e/2PACX-1vT7dc6hP4sKyMJupklbGK4adIf3qCkt4r-HrEWO8jTRMx9uUOUSfboKG749IF3DZr8k6zUPSLXkrDGY/pub"),"en"==Code.getLang()&&(t="https://docs.google.com/document/d/e/2PACX-1vSk-9T56hP9K9EOhkF5SoNzsYl4TzDk-GEDnMssaFP_m-LEfI6IU-uRkkLP_HoONK0QmMrZVo_f27Fw/pub"),"mpu6050"==o&&(t+="#h.79fbsr8dha21"),"tm1640"==o&&(t+="#h.iw35vui9vzi1"),"ds1820"==o&&(t+="#h.w84555jgod5j"),"mfrc522"==o&&(t+="#h.owhbali4ayaj"),window.open(t,"_blank").focus()}),window.setTimeout(Code.importPrettify,1)},Code.initLanguage=function(){var e=Code.isRtl();document.dir=e?"rtl":"ltr",document.head.parentElement.setAttribute("lang",Code.LANG);var o=[];for(var t in Code.LANGUAGE_NAME)o.push([Code.LANGUAGE_NAME[t],t]);var n=function(e,o){return e[0]>o[0]?1:e[0]<o[0]?-1:0};o.sort(n);var r=document.getElementById("languageMenu");r.options.length=0;for(var a=0;a<o.length;a++){var s=o[a],t=s[s.length-1],l=new Option(s[0],t);t==Code.LANG&&(l.selected=!0),r.options.add(l)}r.addEventListener("change",Code.changeLanguage,!0),document.getElementById("tab_blocks").textContent=MSG.blocks,document.getElementById("tab_files").textContent=MSG.files,document.getElementById("tab_programs").textContent=MSG.shared,document.getElementById("tab_device").textContent=MSG.device,document.getElementById("linkButton").title=MSG.linkTooltip,document.getElementById("runButton").title=MSG.runTooltip,document.getElementById("saveButton").title=MSG.saveTooltip,document.getElementById("loadButton").title=MSG.loadTooltip,document.getElementById("notificationButton").title=MSG.notificationTooltip,document.getElementById("languageIcon").title=MSG.languageTooltip,document.getElementById("toolbarButton").title=MSG.toolbarTooltip,document.getElementById("forumButton").title=MSG.forumTooltip,document.getElementById("accountButton").title=MSG.accountTooltip},Code.discard=function(){var e=Code.workspace.getAllBlocks().length;(e<2||window.confirm(Blockly.Msg.DELETE_ALL_BLOCKS.replace("%1",e)))&&(Code.workspace.clear(),window.location.hash&&(window.location.hash=""))},document.write('<script src="msg/'+Code.LANG+'.js"></script>\n'),document.write('<script src="b.msg/js/'+Code.LANG+'.js"></script>\n');