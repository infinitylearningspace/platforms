/**
 * @license
 * Copyright 2012 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */ "use strict";var BlocklyStorage={};BlocklyStorage.backupBlocks_=function(e){if("localStorage"in window){var t=e||Blockly.getMainWorkspace(),o=Blockly.Xml.workspaceToDom(t),l=Blockly.Xml.domToText(o);l=UI.workspace.writeWorkspace(l,!1),localStorage.setItem(UI.account.currentProject.uid,l),localStorage.setItem("bipes_projects",JSON.stringify(UI.account.projects))}},BlocklyStorage.backupOnUnload=function(e){var t=e||Blockly.getMainWorkspace();window.addEventListener("unload",function(){BlocklyStorage.backupBlocks_(t)},!1)},BlocklyStorage.restoreBlocks=function(e){if("localStorage"in window){if(e||Blockly.getMainWorkspace(),localStorage.bipes_projects&&"[]"!=localStorage.bipes_projects)try{let t=JSON.parse(localStorage.bipes_projects);UI.account.restoreProjects(t)}catch(o){UI.notify.log(o)}else{let l=Tool.uid();localStorage.setItem(l,Tool.emptyXML());let r=`{"${l}":"${+new Date}"}`;localStorage.setItem("bipes_projects",r),UI.account.restoreProjects(JSON.parse(r))}}},BlocklyStorage.link=function(e){var t=e||Blockly.getMainWorkspace(),o=Blockly.Xml.workspaceToDom(t,!0);if(1==t.getTopBlocks(!1).length&&o.querySelector){var l=o.querySelector("block");l&&(l.removeAttribute("x"),l.removeAttribute("y"))}var r=Blockly.Xml.domToText(o);r=UI.workspace.writeWorkspace(r,!1),BlocklyStorage.makeRequest_("/storage","xml",r,t)},BlocklyStorage.retrieveXml=function(e,t){var o=t||Blockly.getMainWorkspace();BlocklyStorage.makeRequest_("/storage","key",e,o)},BlocklyStorage.httpRequest_=null,BlocklyStorage.makeRequest_=function(e,t,o,l){BlocklyStorage.httpRequest_&&BlocklyStorage.httpRequest_.abort(),BlocklyStorage.httpRequest_=new XMLHttpRequest,BlocklyStorage.httpRequest_.name=t,BlocklyStorage.httpRequest_.onreadystatechange=BlocklyStorage.handleRequest_,BlocklyStorage.httpRequest_.open("POST",e),BlocklyStorage.httpRequest_.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),BlocklyStorage.httpRequest_.send(t+"="+encodeURIComponent(o)),BlocklyStorage.httpRequest_.workspace=l},BlocklyStorage.handleRequest_=function(){if(4==BlocklyStorage.httpRequest_.readyState){if(200!=BlocklyStorage.httpRequest_.status)BlocklyStorage.alert(BlocklyStorage.HTTPREQUEST_ERROR+"\nhttpRequest_.status: "+BlocklyStorage.httpRequest_.status);else{var e=BlocklyStorage.httpRequest_.responseText.trim();"xml"==BlocklyStorage.httpRequest_.name?(window.location.hash=e,BlocklyStorage.alert(BlocklyStorage.LINK_ALERT.replace("%1",window.location.href))):"key"==BlocklyStorage.httpRequest_.name&&(e.length?(UI.account.importProject(e),UI.notify.send("Project imported from link!")):BlocklyStorage.alert(BlocklyStorage.HASH_ERROR.replace("%1",window.location.hash))),BlocklyStorage.monitorChanges_(BlocklyStorage.httpRequest_.workspace)}BlocklyStorage.httpRequest_=null}},BlocklyStorage.monitorChanges_=function(e){var t=Blockly.Xml.workspaceToDom(e),o=Blockly.Xml.domToText(t);function l(){var t=Blockly.Xml.workspaceToDom(e),r=Blockly.Xml.domToText(t);o!=r&&(window.location.hash="",e.removeChangeListener(l))}e.addChangeListener(l)},BlocklyStorage.loadXml_=function(e,t){e=UI.workspace.readWorkspace(e,!1);try{e=Blockly.Xml.textToDom(e)}catch(o){BlocklyStorage.alert(BlocklyStorage.XML_ERROR+"\nXML: "+e);return}t.clear(),Blockly.Xml.domToWorkspace(e,t)},BlocklyStorage.alert=function(e){window.alert(e)};